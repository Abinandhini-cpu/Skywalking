# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


version: '2.1'

services:
  oap:
    environment:
      JAVA_OPTS: -javaagent:/jacoco/jacocoagent.jar=classdumpdir=/jacoco/classes/oap,destfile=/jacoco/oap.exec,includes=org.apache.skywalking.*,excludes=org.apache.skywalking.oap.query.*:org.apache.skywalking.oap.server.core.query.*
        -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
      SW_CLUSTER_ZK_HOST_PORT: zk:2181
      SW_JDBC_URL: jdbc:mysql://mysql:3306/swtest
      SW_STORAGE_ES_CLUSTER_NODES: es:9200
      SW_STORAGE_INFLUXDB_URL: http://influxdb:8086
    expose:
      - '11800'
      - '12800'
      - '5005'
    healthcheck:
      interval: 5s
      retries: 120
      test: ["CMD", "sh", "-c", "nc -nz 127.0.0.1 9090"]
      timeout: 1m
    image: skywalking/oap:latest
    networks:
      - e2e
    restart: on-failure
    volumes:
      - /root/skywalking/test/e2e/e2e-test/docker/download-mysql.sh:/download-mysql.sh:rw
      - /root/skywalking/test/jacoco:/jacoco:rw
  provider:
    build:
      args:
        SW_AGENT_JDK_VERSION: ''
      context: /root/skywalking/test/e2e
      dockerfile: e2e-test/docker/Dockerfile.provider
    depends_on:
      oap:
        condition: service_healthy
    environment:
      JAVA_OPTS: -javaagent:/jacoco/jacocoagent.jar=classdumpdir=/jacoco/classes/provider,destfile=/jacoco/provider.exec,includes=org.apache.skywalking.*,excludes=org.apache.skywalking.apm.dependencies.*
        -javaagent:/skywalking/agent/skywalking-agent.jar=logging.output=CONSOLE -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
      SW_AGENT_COLLECTOR_BACKEND_SERVICES: oap:11800
    expose:
      - '5005'
      - '9090'
    healthcheck:
      interval: 5s
      retries: 120
      test: ["CMD", "sh", "-c", "nc -nz 127.0.0.1 9090"]
      timeout: 1m
    networks:
      - e2e
    volumes:
      - /root/skywalking/test/jacoco:/jacoco:rw
  ui:
    depends_on:
      oap:
        condition: service_healthy
    environment:
      SW_OAP_ADDRESS: oap:12800
    expose:
      - '8080'
    image: skywalking/ui:latest
    networks:
      - e2e

networks:
  e2e: {}